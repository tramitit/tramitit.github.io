<!-- Language List -->
{{ $class := .Class }}
{{ $context := .Context }}
{{ $pageLang := $context.Lang }}
{{ $base:= urls.Parse site.Home.Permalink }}
{{ $siteLanguages := site.Home.AllTranslations }}
{{ $Site:= .Site }}
{{ $lang_str:= (add "/" (add $pageLang "/")) }}
{{ $pageLink := replace (replace $context.RelPermalink $lang_str "/" 1) $base.Path "/" }}
{{ $is_guide:= and (strings.Contains $pageLink "/guides/") (not (hasSuffix $pageLink "/guides/")) }}
{{ $is_categories:= strings.Contains $pageLink "/categories/" }}
{{ $Page:= .}}
{{ errorf (string $siteLanguages) }}
{{ errorf (string .Translations) }}


{{ if $context.IsTranslated }}
  <select class="{{ $class }}" onchange="location = this.value">
    {{ range $siteLanguages }}
      {{ $Language:= .Language }}
      {{ $RelPermalink:= .RelPermalink }}
      {{ if $is_guide }}
        <!-- Can't remap non-guide pages -->
        {{ $translationKey := $context.Params.translationKey }}
        {{ with $translationKey }}
          {{ $docs:= index site.Data.translations.translationKey $translationKey }}
          {{ $language_code:= index (split (string $Language.LanguageCode) "-") 0 }}
          <!-- convert e.g. en-us -> en -->
          {{ $entry:= index $docs $language_code }}
          {{ if eq (string $translationKey ) (string $entry.translationKey ) }}
            <!-- article exists in Language -->
            {{ if eq (string $pageLang) (string $Language) }}
              <option id="{{ $Language }}" value="{{ $entry.slug }}" selected>
                {{ $Language.LanguageName }}
              </option>
            {{ else }}
              <option id="{{ $Language }}" value="{{ $entry.slug }}">
                {{ $Language.LanguageName }}
              </option>
            {{ end }}
          {{ else }}
            <!-- show all languages supported, but not selectable -->
            <option id="{{ $Language }}" value="" disabled>
              {{ $Language.LanguageName }}
            </option>
          {{ end }}
        {{ end }}
      {{ else }}
        {{ if $is_categories }}
          {{ if eq (string $pageLang) (string $Language) }}
            <option
              id="{{ $Language }}"
              value="{{ replace (add $RelPermalink $pageLink) `//` `/` }}"
              selected>
              {{ .Language.LanguageName }}
            </option>
          {{ else }}
            {{ $page:= $AllSites.GetPage (replace (add $RelPermalink $pageLink) `//` `/`) }}
            {{ errorf (replace (add $RelPermalink $pageLink) `//` `/`) }}
            {{ errorf (string $Page.Translations) }}
            {{ errorf (add (add (string $pageLink) (string $page)) (string $Language)) }}
            {{ with $page }}
              <option
                id="{{ $Language }}"
                value="{{ replace (add $RelPermalink $pageLink) `//` `/` }}">
                {{ .Language.LanguageName }}
              </option>
            {{ else }}
              <option
                id="{{ $Language }}"
                value="{{ replace (add $RelPermalink $pageLink) `//` `/` }}"
                disabled>
                {{ .Language.LanguageName }}
              </option>
            {{ end }}
          {{ end }}
        {{ else }}
          <!-- page where translation always exists like home or /guides -->
          {{ if eq (string $pageLang) (string $Language) }}
            <option
              id="{{ $Language }}"
              value="{{ replace (add $RelPermalink $pageLink) `//` `/` }}"
              selected>
              {{ .Language.LanguageName }}
            </option>
          {{ else }}
            <option
              id="{{ $Language }}"
              value="{{ replace (add $RelPermalink $pageLink) `//` `/` }}">
              {{ .Language.LanguageName }}
            </option>
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}
  </select>
{{ end }}
