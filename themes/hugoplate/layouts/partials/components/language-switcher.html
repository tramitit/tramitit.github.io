<!-- Language List -->
{{ $class := .Class }}
{{ $context := .Context }}
<!-- Current document -->
{{ $pageLang := $context.Lang }}
{{ $base:= urls.Parse site.Home.Permalink }}
{{ $siteLanguages := site.Home.AllTranslations }}

{{ $lang_str:= (add "/" (add $pageLang "/")) }}
{{ $pageLink := replace (replace $context.RelPermalink $lang_str "/" 1) $base.Path "/" }}
{{ $is_guide:= and (strings.Contains $pageLink "/guides/") (not (hasSuffix $pageLink "/guides/")) }}

<!-- current issue, each language is repeated twice -->

{{ if $context.IsTranslated }}
  <select class="{{ $class }}" onchange="location = this.value">
    {{ range $siteLanguages }}
      {{ $Language:= .Language }}
      {{ $RelPermalink:= .RelPermalink }}
      {{ if $is_guide }}
        <!-- No need to remap non-guide pages -->
        {{ $translationKey := $context.Params.translationKey }}
        {{ with $translationKey }}
          {{ $docs:= index site.Data.translations.translationKey $translationKey }}
          {{ $language_code:= index (split (string $Language.LanguageCode) "-") 0 }}
          <!-- convert e.g. en-us -> en -->
          {{ $entry:= index $docs $language_code }}
          {{ if eq (string $translationKey ) (string $entry.translationKey ) }}
            <!-- article exists in Language -->
            {{ if eq (string $pageLang) (string $Language) }}
              <option id="{{ $Language }}" value="{{ $entry.slug }}" selected>
                {{ $Language.LanguageName }}
              </option>
            {{ else }}
              <option id="{{ $Language }}" value="{{ $entry.slug }}">
                {{ $Language.LanguageName }}
              </option>
            {{ end }}
            {{ else }}
            <option id="{{ $Language }}" value="" disabled>
              {{ $Language.LanguageName }}
            </option>
          {{ end }}
        {{ end }}
      {{ else }}
        {{ if eq (string $pageLang) (string $Language) }}
          <option
            id="{{ .Language }}"
            value="{{ replace (add $RelPermalink $pageLink) `//` `/` }}"
            selected>
            {{ .Language.LanguageName }}
          </option>
        {{ else }}
          <option
            id="{{ .Language }}"
            value="{{ replace (add $RelPermalink $pageLink) `//` `/` }}">
            {{ .Language.LanguageName }}
          </option>
        {{ end }}
      {{ end }}
    {{ end }}
  </select>
{{ end }}
<!-- end if translated -->
