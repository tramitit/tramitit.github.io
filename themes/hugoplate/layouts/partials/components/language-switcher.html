<!-- Language List -->
{{ $class := .Class }}
{{ $context := .Context }}
{{ $pageLang := $context.Lang }}
{{ $base:= urls.Parse site.Home.Permalink }}
{{ $siteLanguages := site.Home.AllTranslations }}
{{ $pageLink := replace (replace $context.RelPermalink (add $pageLang "/") "") $base.Path "/" }}

<!-- current issue, each language is reapeated multiple times -->

{{ if $context.IsTranslated }}
  <select class="{{ $class }}" onchange="location = this.value">
  {{ range $siteLanguages }}
    {{ $Language:= .Language }}
    {{ with $context.Params.translationKey }} <!-- translation key for document -->
      {{ $translationKey := $context.Params.translationKey }}
      {{ range site.Data.translations.translationKey }} <!-- loop over translation keys -->
      {{ range . }} <!-- languages -->
      {{ if eq (string $translationKey ) (string .translationKey )}} <!-- article exists in Language -->
        {{ $slug:= .slug }}
        {{ $lang:= .language }}
        {{ $language_code:= index (split (string $Language.LanguageCode) "-") 1 }}
        {{ if eq (string $lang) (string $language_code)}}
          <option
            id="{{ $Language }}"
            value="{{ $slug }}"
            selected>
            {{ $Language.LanguageName }}
          </option>
          {{ else }}
          <option
            id="{{ $Language }}"
            value="{{ $slug }}">
            {{ $Language.LanguageName }}
          </option>
        {{ end }} <!-- end eq language_code -->
      {{ else }} <!-- Article does not exist in language -->
        <option
        id="{{ $Language }}"
        value="{{ .RelPermaLink }}"> <!-- probably wrong, should be in different context -->
        {{ $Language.LanguageName }}
        </option>
      {{ end }} <!-- end eq pageLang language -->
      {{ end }} <!-- end range . -->
      {{ end }} <!-- end range translationKey -->
    {{ else }} <!-- tranlsation key empty -->
        {{ if eq (string $pageLang) (string $Language) }}
          <option
            id="{{ $Language }}"
            value="{{ replace (add .RelPermalink $pageLink) `//` `/` }}"
            selected>
            {{ $Language.LanguageName }}
          </option>
        {{ else }}
          <option
            id="{{ $Language }}"
            value="{{ replace (add .RelPermalink $pageLink) `//` `/` }}">
            {{ $Language.LanguageName }}
          </option>
        {{ end }}
    {{ end }} <!-- end with else -->
    {{ end }}
  </select>
{{ end }} <!-- end if translated -->
